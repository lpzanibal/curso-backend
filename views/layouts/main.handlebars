<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://cdn.socket.io/4.5.3/socket.io.min.js"
        integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi"
        crossorigin="anonymous"></script>
    <title>Productos</title>
</head>

<body style="background-color: rgb(211, 211, 211);">
    <div class="container-sm" style="background-color: white; height: 100vh;">
        {{{body}}}
    </div>
    <script>
        const socket = io();

        socket.on('productos', productos => {

            let tablaHtml = "";
            productos.forEach(producto => {
                tablaHtml += `
                <tr>
                    <td>${producto.title}</td>
                    <td>${producto.price}</td>
                    <td><img src="${producto.thumbnail}" title="${producto.title}" /></td>
                </tr>
                `
            });

            document.getElementById('body-productos').innerHTML = tablaHtml;
        })

        document.getElementById('form-producto').addEventListener('submit', e => {
            e.preventDefault();
            const data = {
                title: document.getElementById('title').value,
                price: document.getElementById('price').value,
                thumbnail: document.getElementById('thumbnail').value,
            }

            fetch("/api/productos", {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

        })


        function mostrarMensajes(mensajes) {
            const mensajesParaMostrar = mensajes.map(({ fecha, autor, texto }) => {
                return `<li>${fecha} - ${autor}: ${texto}</li>`
            })

            document.getElementById('mensajes').innerHTML = `
            <ul>
                ${mensajesParaMostrar.join('\n')}
            </ul>`;

        }

        socket.on('mensajes', mensajes => {
            console.log(mensajes)
            mostrarMensajes(mensajes);
        });

        const botonEnviar = document.getElementById('botonEnviar');

        botonEnviar.addEventListener('click', e => {
            const inputEmail = document.getElementById('email');
            const inputMensaje = document.getElementById('mensaje');

            if (inputEmail.value && inputMensaje.value) {
                const mensaje = {
                    autor: inputEmail.value,
                    texto: inputMensaje.value
                };
                socket.emit('mensaje', mensaje);
            } else {
                alert('Complete los campos');
            }
        })
    </script>
</body>

</html>